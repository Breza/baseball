---
title: "Time to go"
output: html_notebook
---

When should a fan leave a baseball game based solely on the score? Ever since I was a child, my father and I have disagreed over this point.

```{r prep, echo = TRUE}
library(tidyverse)
library(stringr)
library(rvest)
library(readr)
library(reshape2)
library(lubridate)

```

Baseball data come from Retrosheet, which requires the following attribution:
"The information used here was obtained free of charge from and is copyrighted by Retrosheet.  Interested parties may contact Retrosheet at [www.retrosheet.org](www.retrosheet.org)."

For convenice, I took the column names from the source code of the `retrosheet` package.

```{r data, echo = TRUE}
### Acquire and clean data

# Unzip files to the working directory
get_retrosheet <- function() {
  
  # List all hyperlinks on page
links <- read_html("http://www.retrosheet.org/gamelogs/") %>%
  html_nodes("a") %>%
  html_attr("href")

  # Only keep the links to aggregated game files
  links <- links[str_detect(links, "http://www.retrosheet.org/gamelogs/gl[0-9][0-9][0-9][0-9]_[0-9][0-9].*zip")]
  links <- links[!is.na(links)]
  
  # Download and unzip all files
  lapply(links, function(x) {file_name <- basename(x.)
    download.file(x, file_name)
    unzip(file_name)
    TRUE})
  
  file_list <- list.files(pattern = "GL[0-9][0-9][0-9][0-9]\\.TXT$")
  dataset <- lapply(file_list, function(x) read_csv(x, col_names = FALSE)) %>%
    do.call("rbind", .) %>%
    tbl_df()

# Column names from the retrosheet package
# I use all of the names here even though I ignore most of the variables
names(dataset) <- c("Date", "DblHdr", "Day", "VisTm", "VisTmLg", "VisTmGNum", "HmTm",
    "HmTmLg", "HmTmGNum", "VisRuns", "HmRuns", "NumOuts", "DayNight",
    "Completion", "Forfeit", "Protest", "ParkID", "Attendance", "Duration",
    "VisLine", "HmLine", "VisAB", "VisH", "VisD", "VisT", "VisHR",
    "VisRBI", "VisSH", "VisSF", "VisHBP", "VisBB", "VisIBB", "VisK",
    "VisSB", "VisCS", "VisGDP", "VisCI", "VisLOB", "VisPs", "VisER",
    "VisTER", "VisWP", "VisBalks", "VisPO", "VisA", "VisE", "VisPassed",
    "VisDB", "VisTP", "HmAB", "HmH", "HmD", "HmT", "HmHR", "HmRBI",
    "HmSH", "HmSF", "HmHBP", "HmBB", "HmIBB", "HmK", "HmSB", "HmCS",
    "HmGDP", "HmCI", "HmLOB", "HmPs", "HmER", "HmTER", "HmWP", "HmBalks",
    "HmPO", "HmA", "HmE", "HmPass", "HmDB", "HmTP", "UmpHID", "UmpHNm",
    "Ump1BID", "Ump1BNm", "Ump2BID", "Ump2BNm", "Ump3BID", "Ump3BNm",
    "UmpLFID", "UmpLFNm", "UmpRFID", "UmpRFNm", "VisMgrID", "VisMgrNm",
    "HmMgrID", "HmMgrNm", "WinPID", "WinPNm", "PID", "PNAme", "SavePID",
    "SavePNm", "GWinRBIID", "GWinRBINm", "VisStPchID", "VisStPchNm",
    "HmStPchID", "HmStPchNm", "VisBat1ID", "VisBat1Nm", "VisBat1Pos",
    "VisBat2ID", "VisBat2Nm", "VisBat2Pos", "VisBat3ID", "VisBat3Nm",
    "VisBat3Pos", "VisBat4ID", "VisBat4Nm", "VisBat4Pos", "VisBat5ID",
    "VisBat5Nm", "VisBat5Pos", "VisBat6ID", "VisBat6Nm", "VisBat6Pos",
    "VisBat7ID", "VisBat7Nm", "VisBat7Pos", "VisBat8ID", "VisBat8Nm",
    "VisBat8Pos", "VisBat9ID", "VisBat9Nm", "VisBat9Pos", "HmBat1ID",
    "HmBat1Nm", "HmBat1Pos", "HmBat2ID", "HmBat2Nm", "HmBat2Pos",
    "HmBat3ID", "HmBat3Nm", "HmBat3Pos", "HmBat4ID", "HmBat4Nm",
    "HmBat4Pos", "HmBat5ID", "HmBat5Nm", "HmBat5Pos", "HmBat6ID",
    "HmBat6Nm", "HmBat6Pos", "HmBat7ID", "HmBat7Nm", "HmBat7Pos",
    "HmBat8ID", "HmBat8Nm", "HmBat8Pos", "HmBat9ID", "HmBat9Nm",
    "HmBat9Pos", "Additional", "Acquisition")

# Save dataset to a feather file?

# Parse the box score. Possibly replace any ([0-9][0-9]) with a
# character whose code is equal to the number of runs plus some number.
# Then make the data long and convert those characters back to numbers.
for(i in 10:47) {
  dataset$HmLine <- str_replace_all(dataset$HmLine, paste0("\\(", i, "\\)"), paste0("\\",rawToChar(as.raw(i))))
  dataset$VisLine <- str_replace_all(dataset$VisLine, paste0("\\(", i, "\\)"), paste0("\\",rawToChar(as.raw(i))))
}

dataset$HmLine <- str_replace_all(dataset$HmLine, "x", 0)
dataset$VisLine <- str_replace_all(dataset$VisLine, "x", 0)

dataset <- dataset %>%
  mutate(gamecode = paste(Date, VisTm, HmTm, DblHdr, sep = "_")) %>%
  select(gamecode, Date, VisRuns, HmRuns, HmLine, VisLine) %>%
  mutate(Date = ymd(Date)) %>%
  mutate(winner = "tie") %>%
  filter(!is.na(HmLine)) %>%
  filter(!is.na(VisLine)) %>%
  arrange(desc(Date))

# Remove all extra innings
dataset$HmLine <- str_sub(dataset$HmLine, start = 1L, end = 9L)
dataset$VisLine <- str_sub(dataset$VisLine, start = 1L, end = 9L)

# Create one column for each half inning
hmline <- str_split(dataset$HmLine, pattern = "", simplify = TRUE) %>% tbl_df()
names(hmline) <- paste0("inning", 1:9, "hm")
visline <- str_split(dataset$VisLine, pattern = "", simplify = TRUE) %>% tbl_df()
names(visline) <- paste0("inning", 1:9, "vis")

for(i in 10:47) {
  hmline <- apply(hmline, MARGIN = 2, function(x) str_replace_all(x, paste0("\\",rawToChar(as.raw(i))), i))
  visline <- apply(visline, MARGIN = 2, function(x) str_replace_all(x, paste0("\\",rawToChar(as.raw(i))), i))
}

dataset <- select(dataset, -HmLine, -VisLine)
dataset <- cbind(dataset, hmline, visline)

dataset[,6:23] <- apply(dataset[,6:23], MARGIN = 2, as.numeric)

# How many runs did each team score without counting extra innings?
dataset$VisRunsReg <- apply(dataset[,6:14], MARGIN = 1, FUN = sum, na.rm = TRUE)
dataset$HmRunsReg <- apply(dataset[,15:23], MARGIN = 1, FUN = sum, na.rm = TRUE)

dataset <- tbl_df(dataset)

return(dataset)
}

```

Now that we have the data, let's look for trends that might affect our analysis. For example, how common are runs in a baseball game? Has scoring changed since the 19th century?

```{r eda}
### Exploratory data analysis

```


```{r analysis}
### Perform analysis

```

